# Docker部署HZNUOJ教程

鉴于大多数老师没接触过Linux系统，这里先只给出windows下详尽的部署步骤。Linux下的步骤如果有需要可联系我，我再补充。

首先，确保你的系统是 **windows10专业版** ，必须是专业版，因为docker容器引擎需要用到win10专业版才有的hyper-v虚拟机功能。

## 下载所需文件

部署步骤里所有用到的文件我都传到我的网盘上了，各位老师们可以从[这里](http://pan.baidu.com/s/1jHMzsHo)下载。

镜像挺大的，有3个G，百度网盘的限速又比较厉害，请耐心等待。

## 安装Docker

运行下载来的 `InstallDocker.msi` ，安装完后点ok，然后**不要动**，还有些功能在后台部署，大概过3分钟左右会自动重启，重启后过程中会部署一些功能，大约要花1~20分钟。耐心等待，直到再次看到桌面。

然后任务栏右下角会出现一只小鲸鱼，鼠标移上去显示docker is starting...，耐心等待它加载完成，大概也需要1~10分钟不等，加载完成后会跳出一个消息框，显示docker is running，就是加载完毕了。

## 配置Docker

然后右击小鲸鱼图标，选择settings，在弹出的窗口里，点击shared drives，在里面勾上你允许docker使用的盘符，可以尽量选一个空闲空间大一点的盘。然后在Advanced里可以配置你允许docker使用的CPU核心数和内存，可以全部拉满，内存可以少给一点，以免本身内存不够用。设置好后点击Apply生效，可能会让你输入windows账户密码，如果没有密码请去设置一个，docker不接受空密码（ghost安装的系统一般会没有密码）。

## 导入镜像

然后进入你放下载来的镜像的文件夹，shift+右键点击空白处，选择在此处打开命令窗口，然后输入`docker load -i hznuoj2.1.tar`，耐心等待导入完成。

## 运行镜像

镜像导入完成后，运行镜像，输入命令：

`docker run -it --name hznuoj2.1 -p 80:80 hznuoj:2.1 /bin/bash`

成功后你将进入一个完整的ubuntu命令行界面，里面已经部署好了一切。但是需要你重新启动三个服务，运行下面三个命令

`service apache2 restart`

`service mysql restart`

`sudo judged`

**以后每次重启也请重打一遍这三个命令。**

现在你可以打开浏览器，输入`localhost/OJ`，即可访问系统了。和你同一个内网的人，也可以通过输入地址 `(你的内网IP)/OJ` 访问。

## WEB端配置

服务器内置了一个管理员账户，账号密码均为admin，可以直接像普通账号一样登录，登录后为了安全请**立即修改密码**。此管理员拥有最高权限，点击右上角的`用户名->admin`可以进入后台，可以在后台进行题目、比赛、公告、用户的管理。

至此为止整个部署过程就结束了。如果对WEB开发比较熟悉的老师，也可以自己修改系统，所有的源码都存在`/var/www` 目录下。如果有心的话，还可以在GitHub上fork一下我的项目进行修改，然后向我提交pull request，从而一起参与进HZNUOJ的开发。

## 求个赞

最后，不要脸的求个赞。

就是最顶上，右上角的那颗小星星（Star），看到了没，注册一个账号，点一下~

这个星星对我挺重要，如果能给我颗星星将是对我莫大的支持，鞠躬！

接下来是一些细枝末节，也挺重要，请耐心浏览一下。

## 维护相关

#### 班级列表修改

班级列表因为以前都是自己学校在用，所以没有做特别友好的修改接口。是写死在代码里的。

如果想修改班级列表，请打开`/var/www/html/web/OJ/include/classList.inc.php`

在里面按格式修改即可。

#### 重启服务器

如果服务器意外关机，可以通过如下步骤重新运行（不要按照上面的教程再run一遍）：

`docker start hznuoj2.1`

`docker attach hznuoj2.1`

然后重启三个服务即可

`service apache2 restart`

`service mysql restart`

`sudo judged`

#### 一个小BUG

现在已知一个小BUG，就是服务器意外关机后，有概率出现Python所有的提交都是Wrong Answer。这时候请在容器内部重启下判题守护进程：

`pidof judged`

会跳出一个id，kill掉它

`kill -9 刚刚的id`

然后重启程序

`sudo judged`
